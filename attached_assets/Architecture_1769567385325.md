# TravelOrchestrator - Arquitectura Fase 1

## ğŸ“‹ Overview

**TravelOrchestrator** es una aplicaciÃ³n de planificaciÃ³n de viajes inteligente que permite:
- Crear viajes multiusuario con roles dinÃ¡micos
- Generar itinerarios automÃ¡ticos con IA (GPT-4o Mini)
- Reoptimizar dinÃ¡micamente cuando algo falla (Claude Haiku)
- Gestionar presupuestos, reservas y cambios en tiempo real
- ColaboraciÃ³n entre viajeros

---

## ğŸ—ï¸ Stack TecnolÃ³gico

| Capa | TecnologÃ­a | RazÃ³n |
|------|-----------|-------|
| **Frontend** | React 18 + Vite | Desarrollo rÃ¡pido, HMR |
| **Backend** | Node.js + Express | AsincrÃ³nico, rÃ¡pido |
| **Base de Datos** | Supabase (PostgreSQL) | Realtime, auth integrado, escalable |
| **IA - GeneraciÃ³n** | OpenAI GPT-4o Mini | GeneraciÃ³n de itinerarios |
| **IA - ReoptimizaciÃ³n** | Anthropic Claude 3.5 Haiku | Razonamiento sobre cambios |
| **APIs Externas** | Google Maps, OpenWeather | Distancias, clima |
| **Deployment** | Vercel (frontend) + Railway (backend) | Gratuito/econÃ³mico |

---

## ğŸ“Š Base de Datos Schema

```sql
-- Tabla: users
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(255) NOT NULL,
  avatar_url VARCHAR(255),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabla: trips
CREATE TABLE trips (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title VARCHAR(255) NOT NULL,
  destination VARCHAR(255) NOT NULL,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  total_budget DECIMAL(10, 2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'USD',
  description TEXT,
  created_by UUID NOT NULL REFERENCES users(id),
  status VARCHAR(50) DEFAULT 'planning', -- planning, ongoing, completed
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabla: trip_members (roles dinÃ¡micos)
CREATE TABLE trip_members (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  trip_id UUID NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role VARCHAR(50) DEFAULT 'member', -- organizer, member, viewer
  invited_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  accepted_at TIMESTAMP,
  UNIQUE(trip_id, user_id)
);

-- Tabla: trip_preferences (preferencias del usuario para IA)
CREATE TABLE trip_preferences (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  trip_id UUID NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  interests TEXT[] DEFAULT ARRAY[]::TEXT[], -- ['cultural', 'food', 'nature', 'nightlife']
  travel_pace VARCHAR(50) DEFAULT 'moderate', -- relaxed, moderate, fast
  accommodation_type VARCHAR(50) DEFAULT 'mid-range', -- budget, mid-range, luxury
  dietary_restrictions TEXT[] DEFAULT ARRAY[]::TEXT[],
  max_daily_activities INT DEFAULT 4,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabla: itineraries (itinerarios generados por IA)
CREATE TABLE itineraries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  trip_id UUID NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
  generated_by UUID NOT NULL REFERENCES users(id),
  version INT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  is_active BOOLEAN DEFAULT TRUE
);

-- Tabla: itinerary_days (dÃ­as del itinerario)
CREATE TABLE itinerary_days (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  itinerary_id UUID NOT NULL REFERENCES itineraries(id) ON DELETE CASCADE,
  day_number INT NOT NULL,
  date DATE NOT NULL,
  theme VARCHAR(255), -- "Cultural exploration", "Adventure day", etc.
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabla: activities (actividades por dÃ­a)
CREATE TABLE activities (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  day_id UUID NOT NULL REFERENCES itinerary_days(id) ON DELETE CASCADE,
  activity_order INT NOT NULL,
  time_start TIME,
  time_end TIME,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  location VARCHAR(255),
  estimated_cost DECIMAL(10, 2),
  category VARCHAR(50), -- 'dining', 'sightseeing', 'transport', 'activity', 'rest'
  ai_generated BOOLEAN DEFAULT TRUE,
  status VARCHAR(50) DEFAULT 'planned', -- planned, ongoing, completed, skipped, modified
  notes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabla: reservations (reservas: hoteles, vuelos, tours)
CREATE TABLE reservations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  trip_id UUID NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
  type VARCHAR(50) NOT NULL, -- 'flight', 'hotel', 'tour', 'restaurant'
  provider VARCHAR(255),
  confirmation_number VARCHAR(255),
  title VARCHAR(255) NOT NULL,
  date_start DATE NOT NULL,
  date_end DATE,
  time_start TIME,
  location VARCHAR(255),
  cost DECIMAL(10, 2) NOT NULL,
  notes TEXT,
  booking_url VARCHAR(500),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabla: budget_tracking (seguimiento de gastos)
CREATE TABLE budget_tracking (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  trip_id UUID NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id),
  category VARCHAR(50) NOT NULL, -- 'accommodation', 'food', 'transport', 'activities', 'other'
  description VARCHAR(255),
  amount DECIMAL(10, 2) NOT NULL,
  date DATE NOT NULL,
  payment_method VARCHAR(50), -- 'cash', 'card', 'digital'
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabla: reoptimization_logs (historial de reoptimizaciones)
CREATE TABLE reoptimization_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  trip_id UUID NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
  triggered_by VARCHAR(255), -- 'flight_delay', 'closed_attraction', 'weather', 'manual'
  trigger_data JSONB,
  ai_suggestion TEXT,
  user_decision VARCHAR(50), -- 'accepted', 'rejected', 'modified'
  changes_applied JSONB,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Ãndices para optimizaciÃ³n
CREATE INDEX idx_trips_created_by ON trips(created_by);
CREATE INDEX idx_trip_members_trip_id ON trip_members(trip_id);
CREATE INDEX idx_trip_members_user_id ON trip_members(user_id);
CREATE INDEX idx_activities_day_id ON activities(day_id);
CREATE INDEX idx_budget_trip_id ON budget_tracking(trip_id);
```

---

## ğŸ”„ Flujos Principales

### 1. **Crear Trip**
```
Usuario A (Organizer) crea trip
â”œâ”€ Ingresa: destino, fechas, budget, preferencias
â”œâ”€ Sistema crea trip + miembros vacÃ­o
â””â”€ Organizer invita a Usuario B, C, D
   â”œâ”€ Emails enviados
   â””â”€ Estado: pending acceptance
```

### 2. **Generar Itinerario (IA)**
```
Organizer presiona "Generate with AI"
â”œâ”€ Backend llama a OpenAI GPT-4o Mini
â”‚  â”œâ”€ Prompt incluye: destino, fechas, budget, preferencias combinadas
â”‚  â”œâ”€ Respuesta: itinerario JSON estructurado
â”‚  â””â”€ Sistema mapea a DB (itineraries â†’ itinerary_days â†’ activities)
â”œâ”€ Frontend visualiza dÃ­a a dÃ­a
â””â”€ Todos los miembros ven en realtime (Supabase subscription)
```

### 3. **Reoptimizar (Claude Haiku)**
```
Evento dispara reoptimizaciÃ³n:
â”œâ”€ Usuario marca actividad como "Skipped" o "Failed"
â”œâ”€ Backend recopila:
â”‚  â”œâ”€ Actividades restantes del dÃ­a
â”‚  â”œâ”€ Presupuesto disponible
â”‚  â”œâ”€ Preferencias de usuario
â”‚  â””â”€ Itinerario actual
â”œâ”€ Claude Haiku analiza y sugiere cambios
â”‚  â”œâ”€ "Puedes desplazar [Activity A] a maÃ±ana"
â”‚  â”œâ”€ "Sugiero [New Activity] cercano"
â”‚  â””â”€ "Impacto presupuestario: +$50"
â”œâ”€ Usuario aprueba/rechaza/modifica
â””â”€ Sistema actualiza itinerario
```

### 4. **ColaboraciÃ³n Multiusuario**
```
Usuario A modifica actividad
â”œâ”€ Supabase realtime dispara evento
â”œâ”€ Todos conectados reciben actualizaciÃ³n
â”œâ”€ NotificaciÃ³n: "Usuario A cambiÃ³ horario de [Activity]"
â””â”€ Versioning automÃ¡tico (itineraries.version++)
```

---

## ğŸ¨ Componentes Frontend (React)

```
App/
â”œâ”€ Auth/
â”‚  â”œâ”€ LoginPage
â”‚  â””â”€ SignupPage
â”œâ”€ Dashboard/
â”‚  â”œâ”€ TripsList
â”‚  â””â”€ TripDetail
â”œâ”€ Trip/
â”‚  â”œâ”€ TripCreator (wizard: destino, fechas, budget, invites)
â”‚  â”œâ”€ TripPreferences (seleccionar intereses, pace, etc)
â”‚  â”œâ”€ ItineraryGenerator (botÃ³n "Generate with AI" + loading)
â”‚  â”œâ”€ ItineraryViewer (visualizaciÃ³n dÃ­a a dÃ­a)
â”‚  â”‚  â”œâ”€ DayCard
â”‚  â”‚  â”‚  â”œâ”€ ActivityCard (editable)
â”‚  â”‚  â”‚  â””â”€ AddActivityButton
â”‚  â”‚  â””â”€ ReoptimizationPanel (sugerencias IA)
â”‚  â”œâ”€ ReservationManager (CRUD reservas)
â”‚  â”œâ”€ BudgetTracker (gastos por categorÃ­a)
â”‚  â””â”€ CollaborationPanel (miembros, roles, notificaciones)
â””â”€ Shared/
   â”œâ”€ Header
   â”œâ”€ Sidebar
   â””â”€ NotificationCenter
```

---

## ğŸ”— API Endpoints (Backend)

```
AUTH
POST   /api/auth/register
POST   /api/auth/login
POST   /api/auth/logout

TRIPS
GET    /api/trips (mis viajes)
POST   /api/trips (crear nuevo)
GET    /api/trips/:tripId
PUT    /api/trips/:tripId
DELETE /api/trips/:tripId
POST   /api/trips/:tripId/members (invitar)
PUT    /api/trips/:tripId/members/:userId (cambiar rol)

PREFERENCES
GET    /api/trips/:tripId/preferences
PUT    /api/trips/:tripId/preferences

ITINERARIES
POST   /api/trips/:tripId/itineraries/generate (IA generaciÃ³n)
GET    /api/trips/:tripId/itineraries
GET    /api/itineraries/:itineraryId

ACTIVITIES
GET    /api/itineraries/:itineraryId/activities
PUT    /api/activities/:activityId (marcar skipped, completed, etc)
DELETE /api/activities/:activityId
POST   /api/activities/:activityId/reoptimize (sugerir cambios)

RESERVATIONS
GET    /api/trips/:tripId/reservations
POST   /api/trips/:tripId/reservations
PUT    /api/reservations/:reservationId
DELETE /api/reservations/:reservationId

BUDGET
GET    /api/trips/:tripId/budget/summary
POST   /api/trips/:tripId/budget/expense
GET    /api/trips/:tripId/budget/expenses
```

---

## ğŸ¤– Prompts IA

### GPT-4o Mini (GeneraciÃ³n Itinerario)
```
You are a travel itinerary expert. Generate a detailed day-by-day itinerary for:
- Destination: {destination}
- Dates: {startDate} to {endDate} ({numDays} days)
- Budget: ${totalBudget}
- Interests: {interests} (e.g., ['cultural', 'food', 'nature'])
- Travel pace: {pace} (relaxed/moderate/fast)
- Accommodations: {accommodationType}
- Group size: {groupSize} people
- Special considerations: {dietaryRestrictions}, {mobilityNeeds}

Generate ONLY valid JSON with this structure:
{
  "itinerary": [
    {
      "day": 1,
      "date": "2025-03-15",
      "theme": "Arrival and orientation",
      "activities": [
        {
          "time": "14:00",
          "title": "Arrive at hotel",
          "location": "Downtown Vegas",
          "description": "Check-in and rest",
          "estimatedCost": 0,
          "category": "accommodation",
          "duration": 120
        }
      ]
    }
  ]
}
```

### Claude Haiku (ReoptimizaciÃ³n)
```
The traveler just skipped/failed this activity: {activity}
Current day remaining time: {remainingTime}
Remaining budget today: ${remainingBudget}
Other activities today: {otherActivities}

Suggest 2-3 alternative activities or schedule adjustments. Consider:
1. Location proximity
2. Cost constraints
3. Time availability
4. User preferences: {userPreferences}

Respond with structured suggestions, each with impact analysis.
```

---

## ğŸ“± Realtime Features (Supabase)

```javascript
// Escuchar cambios en itinerario
supabase
  .channel(`itinerary:${itineraryId}`)
  .on('postgres_changes', 
    { event: '*', schema: 'public', table: 'activities' },
    (payload) => {
      // Actualizar UI automÃ¡ticamente
      dispatch(updateActivity(payload.new))
    }
  )
  .subscribe()
```

---

## ğŸš€ Fase 1 MVP Scope

**Incluido:**
- âœ… Auth (registro, login, logout)
- âœ… CRUD Trips + Multiusuario
- âœ… Trip Preferences (intereses, pace, etc)
- âœ… IA Trip Generator (GPT-4o Mini)
- âœ… Itinerary Viewer & Editor
- âœ… Reoptimization Suggester (Claude Haiku)
- âœ… Budget Tracker (bÃ¡sico)
- âœ… Reservation Manager (CRUD simple)
- âœ… Realtime Collaboration (Supabase)
- âœ… Notificaciones bÃ¡sicas

**No Incluido (Fase 2):**
- âŒ IntegraciÃ³n Google Maps/Weather (API calls)
- âŒ Booking/Skyscanner integration
- âŒ Export PDF/Email
- âŒ Mobile app native
- âŒ Advanced notifications (SMS, push)
- âŒ Payment processing
- âŒ Analytics dashboard

---

## ğŸ” Seguridad

- **Auth:** JWT via Supabase
- **CORS:** Configurado para frontend URL
- **RLS:** Row-Level Security en Supabase
  - Users solo ven sus trips
  - Trip members solo ven su trip
  - Roles: organizer (full control), member (edit activities), viewer (read-only)

---

## ğŸ“ˆ Escalabilidad Fase 1 â†’ Fase 2

- Agregar Google Maps API para distancias/horarios
- IntegraciÃ³n Skyscanner/Amadeus para vuelos
- Booking.com API para hoteles
- OpenWeather API para alertas climÃ¡ticas
- Webhook para notificaciones en tiempo real
- GraphQL (opcional, si volumen crece)

---

## ğŸ“š Variables de Entorno

```bash
# Backend
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_KEY=your_service_key
OPENAI_API_KEY=your_openai_key
ANTHROPIC_API_KEY=your_anthropic_key
JWT_SECRET=your_jwt_secret
NODE_ENV=development

# Frontend
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
VITE_API_URL=http://localhost:3000
```

---

## ğŸ§ª Testing (Fase 1)

- Unit tests (Jest): Funciones de lÃ³gica
- Integration tests: API endpoints
- E2E tests: Flujos principales (Cypress)

---

**Documento preparado. Vamos a cÃ³digo en Replit.** ğŸš€
