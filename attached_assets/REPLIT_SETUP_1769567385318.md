# Proyecto TravelOrchestrator - Replit Setup

## âš¡ INSTRUCCIONES REPLIT

### OpciÃ³n A: Crear desde cero en Replit
1. Ve a [replit.com](https://replit.com)
2. Crea un nuevo Replit
3. Selecciona "Node.js"
4. Copia todo el cÃ³digo abajo en los archivos

### OpciÃ³n B: Usar este template
**Pendiente publicar template en Replit** (en progreso)

---

## ðŸ“ Estructura Replit

```
.
â”œâ”€ package.json (BACKEND)
â”œâ”€ .env.example
â”œâ”€ public/ (serÃ¡ frontend build)
â”œâ”€ src/
â”‚  â”œâ”€ app.js (Express server)
â”‚  â”œâ”€ routes/
â”‚  â”‚  â”œâ”€ auth.js
â”‚  â”‚  â”œâ”€ trips.js
â”‚  â”‚  â”œâ”€ itineraries.js
â”‚  â”‚  â”œâ”€ activities.js
â”‚  â”‚  â””â”€ ai.js
â”‚  â”œâ”€ controllers/
â”‚  â”‚  â”œâ”€ tripController.js
â”‚  â”‚  â”œâ”€ aiController.js
â”‚  â”‚  â””â”€ budgetController.js
â”‚  â”œâ”€ middleware/
â”‚  â”‚  â””â”€ auth.js
â”‚  â”œâ”€ services/
â”‚  â”‚  â”œâ”€ openaiService.js
â”‚  â”‚  â”œâ”€ claudeService.js
â”‚  â”‚  â””â”€ supabaseService.js
â”‚  â””â”€ utils/
â”‚     â”œâ”€ validators.js
â”‚     â””â”€ errors.js
â””â”€ frontend/ (React app separada)
```

---

## ðŸš€ PASO 1: Backend (Replit Principal)

### package.json
```json
{
  "name": "travelorchestrator-backend",
  "version": "1.0.0",
  "description": "AI-powered trip planning backend",
  "main": "src/app.js",
  "scripts": {
    "dev": "nodemon src/app.js",
    "start": "node src/app.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "@supabase/supabase-js": "^2.38.4",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.1.0",
    "axios": "^1.6.0",
    "openai": "^4.20.0",
    "@anthropic-ai/sdk": "^0.9.0"
  },
  "devDependencies": {
    "nodemon": "^3.0.1"
  }
}
```

### .env.example
```bash
# Supabase
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_KEY=your_service_key

# APIs (agrega despuÃ©s)
OPENAI_API_KEY=sk_...
ANTHROPIC_API_KEY=sk-ant-...

# JWT
JWT_SECRET=your_super_secret_key_change_this

# Server
PORT=3000
NODE_ENV=development
FRONTEND_URL=http://localhost:5173
```

### src/app.js
```javascript
const express = require('express');
const cors = require('cors');
require('dotenv').config();

const app = express();

// Middleware
app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:5173',
  credentials: true
}));
app.use(express.json());

// Health check
app.get('/api/health', (req, res) => {
  res.json({ status: 'OK', message: 'TravelOrchestrator API running' });
});

// Routes (se van a crear abajo)
app.use('/api/auth', require('./routes/auth'));
app.use('/api/trips', require('./routes/trips'));
app.use('/api/itineraries', require('./routes/itineraries'));
app.use('/api/activities', require('./routes/activities'));
app.use('/api/ai', require('./routes/ai'));

// Error handler
app.use((err, req, res, next) => {
  console.error(err);
  res.status(err.status || 500).json({
    error: err.message || 'Internal Server Error'
  });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`ðŸš€ TravelOrchestrator Backend running on port ${PORT}`);
});

module.exports = app;
```

### src/services/supabaseService.js
```javascript
const { createClient } = require('@supabase/supabase-js');

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_ANON_KEY
);

module.exports = supabase;
```

### src/services/openaiService.js
```javascript
const OpenAI = require('openai');

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

const generateItinerary = async (tripData) => {
  const { destination, startDate, endDate, budget, interests, pace } = tripData;
  
  try {
    const prompt = `Generate a detailed day-by-day travel itinerary in JSON format for:
- Destination: ${destination}
- Duration: ${startDate} to ${endDate}
- Budget: $${budget}
- Interests: ${interests.join(', ')}
- Travel pace: ${pace}

Return ONLY valid JSON with structure:
{
  "itinerary": [
    {
      "day": 1,
      "theme": "string",
      "activities": [
        {
          "time": "HH:MM",
          "title": "string",
          "location": "string",
          "description": "string",
          "estimatedCost": number,
          "category": "string",
          "duration": number
        }
      ]
    }
  ]
}`;

    const response = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        { role: 'system', content: 'You are a professional travel planner. Generate realistic, detailed itineraries.' },
        { role: 'user', content: prompt }
      ],
      temperature: 0.7,
      max_tokens: 4000
    });

    const content = response.choices[0].message.content;
    const jsonMatch = content.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('Invalid JSON from OpenAI');
    
    return JSON.parse(jsonMatch[0]);
  } catch (error) {
    console.error('OpenAI Error:', error);
    // Demo mode
    return {
      itinerary: [
        {
          day: 1,
          theme: 'Arrival and orientation',
          activities: [
            {
              time: '14:00',
              title: 'Check into hotel',
              location: 'Downtown',
              description: 'Settle in and rest',
              estimatedCost: 0,
              category: 'accommodation',
              duration: 120
            }
          ]
        }
      ]
    };
  }
};

module.exports = { generateItinerary };
```

### src/services/claudeService.js
```javascript
const Anthropic = require('@anthropic-ai/sdk');

const client = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY
});

const reoptimizeItinerary = async (dayData, failedActivity, preferences) => {
  try {
    const prompt = `The traveler failed/skipped this activity today: "${failedActivity.title}"
Current remaining activities: ${dayData.activities.map(a => a.title).join(', ')}
Remaining budget today: $${dayData.remainingBudget}
Remaining time: ${dayData.remainingTime} hours
User preferences: ${JSON.stringify(preferences)}

Suggest 2-3 alternatives to adjust the day. Consider proximity, budget, and time. 
Return as JSON with suggestions field containing array of suggestions.`;

    const message = await client.messages.create({
      model: 'claude-3-5-haiku-20241022',
      max_tokens: 1024,
      messages: [
        { role: 'user', content: prompt }
      ]
    });

    const content = message.content[0].text;
    const jsonMatch = content.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('Invalid JSON from Claude');
    
    return JSON.parse(jsonMatch[0]);
  } catch (error) {
    console.error('Claude Error:', error);
    // Demo mode
    return {
      suggestions: [
        {
          title: 'Alternative activity 1',
          reason: 'Close by, similar cost',
          estimatedCost: 50,
          duration: 120
        }
      ]
    };
  }
};

module.exports = { reoptimizeItinerary };
```

### src/middleware/auth.js
```javascript
const jwt = require('jsonwebtoken');

const authMiddleware = (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1];
  
  if (!token) {
    return res.status(401).json({ error: 'No token provided' });
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    res.status(401).json({ error: 'Invalid token' });
  }
};

module.exports = authMiddleware;
```

### src/routes/auth.js
```javascript
const express = require('express');
const router = express.Router();
const supabase = require('../services/supabaseService');
const jwt = require('jsonwebtoken');
const bcrypt = require('bcryptjs');

router.post('/register', async (req, res) => {
  try {
    const { email, password, name } = req.body;
    
    // Crear usuario en Supabase Auth
    const { data, error } = await supabase.auth.signUpWithPassword({
      email,
      password
    });

    if (error) throw error;

    // Guardar perfil en tabla users
    const { error: profileError } = await supabase
      .from('users')
      .insert([{
        id: data.user.id,
        email,
        name,
        password_hash: await bcrypt.hash(password, 10)
      }]);

    if (profileError) throw profileError;

    // Generar JWT
    const token = jwt.sign(
      { id: data.user.id, email },
      process.env.JWT_SECRET,
      { expiresIn: '7d' }
    );

    res.json({ token, user: { id: data.user.id, email, name } });
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

router.post('/login', async (req, res) => {
  try {
    const { email, password } = req.body;

    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    });

    if (error) throw error;

    const token = jwt.sign(
      { id: data.user.id, email },
      process.env.JWT_SECRET,
      { expiresIn: '7d' }
    );

    const { data: user } = await supabase
      .from('users')
      .select('*')
      .eq('id', data.user.id)
      .single();

    res.json({ token, user });
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

module.exports = router;
```

### src/routes/trips.js
```javascript
const express = require('express');
const router = express.Router();
const supabase = require('../services/supabaseService');
const authMiddleware = require('../middleware/auth');

router.use(authMiddleware);

// GET - Mis viajes
router.get('/', async (req, res) => {
  try {
    const { data, error } = await supabase
      .from('trips')
      .select('*, trip_members(user_id, role)')
      .or(`created_by.eq.${req.user.id},trip_members.user_id.eq.${req.user.id}`)
      .order('created_at', { ascending: false });

    if (error) throw error;
    res.json(data);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// POST - Crear trip
router.post('/', async (req, res) => {
  try {
    const { title, destination, startDate, endDate, totalBudget, description } = req.body;

    const { data: trip, error: tripError } = await supabase
      .from('trips')
      .insert([{
        title,
        destination,
        start_date: startDate,
        end_date: endDate,
        total_budget: totalBudget,
        description,
        created_by: req.user.id
      }])
      .select()
      .single();

    if (tripError) throw tripError;

    // Agregar creador como organizador
    await supabase
      .from('trip_members')
      .insert([{
        trip_id: trip.id,
        user_id: req.user.id,
        role: 'organizer'
      }]);

    res.json(trip);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// PUT - Actualizar trip
router.put('/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const { title, destination, startDate, endDate, totalBudget, description } = req.body;

    const { data, error } = await supabase
      .from('trips')
      .update({
        title,
        destination,
        start_date: startDate,
        end_date: endDate,
        total_budget: totalBudget,
        description
      })
      .eq('id', id)
      .select()
      .single();

    if (error) throw error;
    res.json(data);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// DELETE - Eliminar trip
router.delete('/:id', async (req, res) => {
  try {
    const { id } = req.params;

    const { error } = await supabase
      .from('trips')
      .delete()
      .eq('id', id);

    if (error) throw error;
    res.json({ message: 'Trip deleted' });
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// POST - Invitar miembro
router.post('/:id/invite', async (req, res) => {
  try {
    const { id } = req.params;
    const { email, role } = req.body;

    // Buscar usuario por email
    const { data: user } = await supabase
      .from('users')
      .select('id')
      .eq('email', email)
      .single();

    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }

    const { data, error } = await supabase
      .from('trip_members')
      .insert([{
        trip_id: id,
        user_id: user.id,
        role: role || 'member'
      }])
      .select();

    if (error) throw error;
    res.json(data);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

module.exports = router;
```

### src/routes/ai.js
```javascript
const express = require('express');
const router = express.Router();
const supabase = require('../services/supabaseService');
const { generateItinerary } = require('../services/openaiService');
const { reoptimizeItinerary } = require('../services/claudeService');
const authMiddleware = require('../middleware/auth');

router.use(authMiddleware);

// POST - Generar itinerario
router.post('/generate/:tripId', async (req, res) => {
  try {
    const { tripId } = req.params;

    // Obtener datos del trip
    const { data: trip } = await supabase
      .from('trips')
      .select('*')
      .eq('id', tripId)
      .single();

    // Obtener preferencias combinadas
    const { data: preferences } = await supabase
      .from('trip_preferences')
      .select('*')
      .eq('trip_id', tripId);

    // Generar itinerario con IA
    const itinerary = await generateItinerary({
      destination: trip.destination,
      startDate: trip.start_date,
      endDate: trip.end_date,
      budget: trip.total_budget,
      interests: preferences[0]?.interests || [],
      pace: preferences[0]?.travel_pace || 'moderate'
    });

    // Guardar itinerario en DB
    const { data: savedItinerary, error: saveError } = await supabase
      .from('itineraries')
      .insert([{
        trip_id: tripId,
        generated_by: req.user.id,
        version: 1,
        is_active: true
      }])
      .select()
      .single();

    if (saveError) throw saveError;

    // Guardar dÃ­as y actividades
    for (const dayData of itinerary.itinerary) {
      const { data: dayRecord } = await supabase
        .from('itinerary_days')
        .insert([{
          itinerary_id: savedItinerary.id,
          day_number: dayData.day,
          date: new Date(trip.start_date),
          theme: dayData.theme
        }])
        .select()
        .single();

      // Guardar actividades
      for (const activity of dayData.activities) {
        await supabase
          .from('activities')
          .insert([{
            day_id: dayRecord.id,
            activity_order: dayData.activities.indexOf(activity),
            time_start: activity.time,
            title: activity.title,
            description: activity.description,
            location: activity.location,
            estimated_cost: activity.estimatedCost,
            category: activity.category,
            ai_generated: true,
            status: 'planned'
          }]);
      }
    }

    res.json(savedItinerary);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// POST - Reoptimizar
router.post('/reoptimize/:activityId', async (req, res) => {
  try {
    const { activityId } = req.params;

    // Obtener actividad
    const { data: activity } = await supabase
      .from('activities')
      .select('*')
      .eq('id', activityId)
      .single();

    // Obtener dÃ­a
    const { data: day } = await supabase
      .from('itinerary_days')
      .select('*')
      .eq('id', activity.day_id)
      .single();

    // Obtener otras actividades del dÃ­a
    const { data: otherActivities } = await supabase
      .from('activities')
      .select('*')
      .eq('day_id', activity.day_id);

    // Calcular presupuesto disponible (simplificado)
    const totalCost = otherActivities.reduce((sum, a) => sum + (a.estimated_cost || 0), 0);
    const remainingBudget = 200 - totalCost; // Presupuesto diario asumido

    // Obtener preferencias
    const { data: itinerary } = await supabase
      .from('itinerary_days')
      .select('itineraries(trip_id)')
      .eq('id', activity.day_id)
      .single();

    const { data: preferences } = await supabase
      .from('trip_preferences')
      .select('*')
      .eq('trip_id', itinerary.itineraries.trip_id)
      .limit(1)
      .single();

    // Llamar a Claude para reoptimizar
    const suggestions = await reoptimizeItinerary(
      {
        activities: otherActivities,
        remainingBudget,
        remainingTime: 8 // Horas restantes
      },
      activity,
      preferences || {}
    );

    res.json(suggestions);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

module.exports = router;
```

### src/routes/activities.js
```javascript
const express = require('express');
const router = express.Router();
const supabase = require('../services/supabaseService');
const authMiddleware = require('../middleware/auth');

router.use(authMiddleware);

// GET - Actividades de un dÃ­a
router.get('/day/:dayId', async (req, res) => {
  try {
    const { dayId } = req.params;

    const { data, error } = await supabase
      .from('activities')
      .select('*')
      .eq('day_id', dayId)
      .order('activity_order', { ascending: true });

    if (error) throw error;
    res.json(data);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// PUT - Actualizar actividad (incluye marcar como skipped)
router.put('/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const { status, title, description, location, timeStart, estimatedCost } = req.body;

    const { data, error } = await supabase
      .from('activities')
      .update({
        status,
        title,
        description,
        location,
        time_start: timeStart,
        estimated_cost: estimatedCost
      })
      .eq('id', id)
      .select()
      .single();

    if (error) throw error;
    res.json(data);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// DELETE - Eliminar actividad
router.delete('/:id', async (req, res) => {
  try {
    const { id } = req.params;

    const { error } = await supabase
      .from('activities')
      .delete()
      .eq('id', id);

    if (error) throw error;
    res.json({ message: 'Activity deleted' });
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

module.exports = router;
```

### src/routes/itineraries.js
```javascript
const express = require('express');
const router = express.Router();
const supabase = require('../services/supabaseService');
const authMiddleware = require('../middleware/auth');

router.use(authMiddleware);

// GET - Itinerario de un trip
router.get('/trip/:tripId', async (req, res) => {
  try {
    const { tripId } = req.params;

    const { data, error } = await supabase
      .from('itineraries')
      .select(`
        *,
        itinerary_days(
          *,
          activities(*)
        )
      `)
      .eq('trip_id', tripId)
      .eq('is_active', true)
      .single();

    if (error) throw error;
    res.json(data);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

module.exports = router;
```

---

## ðŸŽ¨ PASO 2: Frontend (Proyecto Separado React)

Para el frontend, puedes crear en otro Replit o localmente:

```bash
npm create vite@latest frontend -- --template react
cd frontend
npm install axios zustand @supabase/supabase-js
```

### Componentes clave (se detallan en el siguiente documento)
- LoginPage.jsx
- TripCreator.jsx  
- ItineraryGenerator.jsx
- ItineraryViewer.jsx
- ReoptimizationPanel.jsx
- BudgetTracker.jsx

---

## âœ… Checklist Setup

- [ ] Crear cuenta Supabase (gratuito)
- [ ] Crear proyecto en Supabase
- [ ] Copiar URL y keys a .env
- [ ] Ejecutar SQL schema en Supabase
- [ ] Crear Replit (Node.js)
- [ ] Copiar backend code
- [ ] `npm install`
- [ ] `npm run dev` (backend corre en :3000)
- [ ] Crear Replit frontend (React) O usa `npm create vite`
- [ ] Conectar frontend al backend
- [ ] Testear registro/login
- [ ] Crear trip de prueba
- [ ] Generar itinerario (demo mode)
- [ ] Agregar OpenAI key cuando disponible
- [ ] Testear IA real

---

**Â¡Listo! El backend estÃ¡ corriendo.** ðŸš€

PrÃ³ximo paso: Frontend en React. Â¿Continuo?
